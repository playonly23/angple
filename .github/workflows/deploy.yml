name: Build and Deploy to ECR + Komodo

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    # OIDC ê¶Œí•œ ì„¤ì •
    permissions:
      id-token: write
      contents: read
    
    strategy:
      matrix:
        component: [web, admin]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials using OIDC
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
        aws-region: ${{ secrets.AWS_REGION }}
        
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2
      
    - name: Build, tag, and push ${{ matrix.component }} image to Amazon ECR
      id: build-image
      env:
        IMAGE_TAG: ${{ github.sha }}
        BRANCH_NAME: ${{ github.ref_name }}
      run: |
        echo "Building ${{ matrix.component }} Docker image..."
        
        # Docker ì´ë¯¸ì§€ ë¹Œë“œ (í•˜ë‚˜ì˜ ë¦¬í¬ì§€í† ë¦¬ì— íƒœê·¸ë¡œ êµ¬ë¶„)
        docker build -f apps/${{ matrix.component }}/Dockerfile -t ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY }}:${{ matrix.component }}-$IMAGE_TAG .
        docker build -f apps/${{ matrix.component }}/Dockerfile -t ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY }}:${{ matrix.component }}-latest .
        docker build -f apps/${{ matrix.component }}/Dockerfile -t ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY }}:${{ matrix.component }}-$BRANCH_NAME-latest .
        
        echo "Pushing ${{ matrix.component }} images to ECR..."
        # ECRì— í‘¸ì‹œ
        docker push ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY }}:${{ matrix.component }}-$IMAGE_TAG
        docker push ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY }}:${{ matrix.component }}-latest
        docker push ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY }}:${{ matrix.component }}-$BRANCH_NAME-latest
        
        # ì¶œë ¥ ë³€ìˆ˜ ì„¤ì •
        echo "image=${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY }}:${{ matrix.component }}-$IMAGE_TAG" >> $GITHUB_OUTPUT
        
    - name: Deploy to Komodo (Optional)
      if: github.ref == 'refs/heads/main' && matrix.component == 'web'
      env:
        IMAGE_URI: ${{ steps.build-image.outputs.image }}
        KOMODO_KEY: ${{ secrets.KOMODO_API_KEY }}
        KOMODO_SECRET: ${{ secrets.KOMODO_API_SECRET }}
      run: |
        echo "Triggering Komodo deployment..."
        
        WEB_IMAGE="${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY }}:web-${{ github.sha }}"
        ADMIN_IMAGE="${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY }}:admin-${{ github.sha }}"
        
        # Komodo API í˜¸ì¶œ (ì‹¤ì œ Komodo ì„¤ì • í›„ í™œì„±í™”)
        # curl -X POST "https://komodo.damoang.net/api/deployment/deploy" \
        #   -H "Authorization: Bearer $KOMODO_KEY:$KOMODO_SECRET" \
        #   -H "Content-Type: application/json" \
        #   -d '{
        #     "deployment_id": "damoang-web",
        #     "image": "'$WEB_IMAGE'",
        #     "branch": "'$GITHUB_REF_NAME'"
        #   }'
        
        echo "âœ… Images pushed successfully:"
        echo "- Web: $WEB_IMAGE"
        echo "- Admin: $ADMIN_IMAGE"
        
    - name: Deployment Summary
      if: matrix.component == 'web'
      run: |
        echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Web Image**: ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY }}:web-${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Admin Image**: ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY }}:admin-${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ECR Registry**: ${{ secrets.ECR_REGISTRY }}" >> $GITHUB_STEP_SUMMARY
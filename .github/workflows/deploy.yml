# .github/workflows/deploy.yml
name: Build and Deploy to ECR + Komodo

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY: damoang
  KOMODO_API_URL: https://komodo.damoang.net

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    # OIDC 권한 설정
    permissions:
      id-token: write
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials using OIDC
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
        aws-region: ${{ secrets.AWS_REGION }}
        
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2
      
    - name: Build, tag, and push image to Amazon ECR
      id: build-image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
        BRANCH_NAME: ${{ github.ref_name }}
      run: |
        echo "Building Docker image..."
        
        # Docker 이미지 빌드
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:latest .
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$BRANCH_NAME-latest .
        
        echo "Pushing images to ECR..."
        # ECR에 푸시
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$BRANCH_NAME-latest
        
        # 출력 변수 설정
        echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT
        echo "registry=$ECR_REGISTRY" >> $GITHUB_OUTPUT
        
    - name: Deploy to Komodo (Optional)
      if: github.ref == 'refs/heads/main'
      env:
        IMAGE_URI: ${{ steps.build-image.outputs.image }}
        KOMODO_TOKEN: ${{ secrets.KOMODO_API_TOKEN }}
      run: |
        echo "Triggering Komodo deployment..."
        
        # Komodo API 호출 (실제 Komodo 설정 후 활성화)
        # curl -X POST "$KOMODO_API_URL/api/deployment/deploy" \
        #   -H "Authorization: Bearer $KOMODO_KEY:$KOMODO_SECRET" \
        #   -H "Content-Type: application/json" \
        #   -d '{
        #     "deployment_id": "ang-gnu-guide",
        #     "image": "'$IMAGE_URI'",
        #     "branch": "'$GITHUB_REF_NAME'"
        #   }'
        
        echo "✅ Image pushed successfully: $IMAGE_URI"
        
    - name: Deployment Summary
      run: |
        echo "## 🚀 Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Image**: ${{ steps.build-image.outputs.image }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ECR Registry**: ${{ steps.build-image.outputs.registry }}" >> $GITHUB_STEP_SUMMARY
